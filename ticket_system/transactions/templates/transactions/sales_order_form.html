<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Order (Touch)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Touch Optimizations */
        .touch-input {
            height: 3rem;
            /* 48px standard touch target */
            font-size: 1rem;
        }

        .touch-btn {
            min-height: 3.5rem;
            /* 56px large target */
        }

        /* Hide scrollbars but keep functionality */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom scrollbar for table if visible */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>

<body class="bg-gray-50 text-slate-800 h-screen w-screen overflow-hidden">

    <!-- Main Content Area - Integration with app.js Sidebar -->
    <!-- app.js will inject sidebar before thisMain and manage md:ml-64 class on this element -->
    <main id="main-content" class="flex flex-col h-full transition-all duration-300 ml-0 md:ml-64 w-auto relative">

        <!-- Mobile Header / Menu Trigger (Matches sliting.html pattern but integrated into context bar or separate) -->
        <div class="md:hidden flex items-center p-2 bg-slate-900 text-white shrink-0">
            <button id="mobile-menu-btn" class="p-2 mr-2">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
            <span class="font-bold">Sales Order</span>
        </div>

        <form method="post" class="flex flex-col h-full">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 shrink-0 mx-4 mt-4">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <!-- 1. Context Bar (Top, Always Visible) -->
            <header
                class="bg-white border-b border-gray-200 p-4 shadow-sm shrink-0 flex items-center justify-between z-20">
                <div class="flex flex-col">
                    <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">Order No</span>
                    <span class="text-2xl font-bold text-indigo-700">{% if form.instance.pk %}{{ form.instance.pk }}{%
                        else %}New{% endif %}</span>
                </div>

                <div class="flex items-center gap-6">
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-gray-500 font-bold uppercase">Status</span>
                        <div class="relative">
                            <select name="status" id="id_status"
                                class="appearance-none bg-yellow-100 text-yellow-800 font-bold py-1 px-3 rounded-full text-sm border-none focus:ring-0 cursor-pointer">
                                {% for value, label in form.fields.status.choices %}
                                <option value="{{ value }}" {% if form.status.value == value %}selected{% endif %}>{{
                                    label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-col items-end hidden sm:flex">
                        <span class="text-xs text-gray-500 font-bold uppercase">Date</span>
                        <input type="date" name="order_date" id="id_order_date"
                            value="{{ form.order_date.value|date:'Y-m-d' }}"
                            class="text-lg font-medium text-gray-800 border-none bg-transparent focus:ring-0 text-right p-0 w-32">
                    </div>
                </div>
            </header>

            <!-- 2. Master Information Section (Fixed height / Scrollable) -->
            <section class="bg-gray-50 p-4 border-b border-gray-200 shrink-0 overflow-y-auto max-h-[30vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <!-- Col 1 -->
                    <div class="space-y-4">
                        <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Customer</label>
                            <div class="flex gap-2">
                                <select name="customer" id="id_customer"
                                    class="touch-input w-full border border-gray-300 rounded px-2 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 {% if form.customer.errors %}border-red-500{% endif %}">
                                    <option value="">Select Customer...</option>
                                    {% for choice in form.fields.customer.queryset %}
                                    <option value="{{ choice.pk }}" {% if form.customer.value|stringformat:"s" == choice.pk|stringformat:"s" %}selected{%endif %}>{{ choice.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% if form.customer.errors %}
                            <p class="text-red-500 text-xs italic mt-1">{{ form.customer.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Delivery Info</label>
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <span class="text-[10px] text-gray-400 uppercase">Delivery Date</span>
                                    <input type="date" name="delivery_date" id="id_delivery_date"
                                        value="{{ form.delivery_date.value|date:'Y-m-d' }}"
                                        class="touch-input w-full border border-gray-300 rounded px-2 bg-white">
                                    {% if form.delivery_date.errors %}
                                    <p class="text-red-500 text-xs italic mt-1">{{ form.delivery_date.errors.0 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Col 2 -->
                    <div class="space-y-4">
                        <div class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Order Details</label>
                            <!-- Note: 'Category' and 'Type' were in the mock but are not in the strict backend model for SalesOrder, skipping them or mapping to remarks if needed. Keeping simpler. -->
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <span class="text-[10px] text-gray-400 uppercase">Remarks / Ref</span>
                                    <textarea name="remarks" id="id_remarks"
                                        class="touch-input w-full border border-gray-300 rounded px-2 bg-white"
                                        rows="1">{{ form.remarks.value|default_if_none:'' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. Detail Workspace (Split into Panel + Table) -->
            <div class="flex-1 flex flex-col md:flex-row overflow-hidden bg-white min-h-0">

                <!-- Schedule Panel (Left/Top - Collapsible) -->
                <!-- Reduced prominence/functionality for MVP integration as backend doesn't support complex scheduling per line yet -->
                <aside
                    class="w-full md:w-1/3 border-b md:border-b-0 md:border-r border-gray-200 flex flex-col bg-slate-50 relative group transition-all duration-300 shrink-0 h-10 md:h-full overflow-hidden"
                    id="schedule-panel">
                    <div class="p-3 bg-slate-100 border-b border-gray-200 flex justify-between items-center cursor-pointer md:cursor-default"
                        onclick="this.parentElement.classList.toggle('h-10'); this.parentElement.classList.toggle('min-h-0')">
                        <h3 class="font-bold text-gray-700">ðŸ“… Delivery Schedule</h3>
                        <span class="text-gray-500 text-xs md:hidden">Tap to expand</span>
                    </div>
                    <div class="p-4 text-gray-500 text-sm italic text-center">
                        Scheduling features coming soon.
                    </div>
                </aside>

                <!-- Item Table (Right/Bottom - Primary) -->
                <section class="flex-1 flex flex-col min-w-0 bg-white relative h-full">
                    <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white z-10">
                        <h3 class="font-bold text-lg text-gray-800">Items</h3>
                    </div>

                    {{ line_formset.management_form }}
                    {% if line_formset.non_form_errors %}
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded m-2">
                        {{ line_formset.non_form_errors }}
                    </div>
                    {% endif %}

                    <div class="flex-1 overflow-y-auto custom-scrollbar relative">
                        <table class="w-full text-left border-collapse">
                            <thead
                                class="sticky top-0 bg-gray-100 z-10 shadow-sm text-xs uppercase text-gray-500 font-semibold">
                                <tr>
                                    <th class="p-3">Item</th>
                                    <th class="p-3 text-right">Qty</th>
                                    <th class="p-3 text-right">Rate</th>
                                    <th class="p-3 w-10"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 text-sm">
                                {% for form in line_formset %}
                                <tr class="active:bg-indigo-50 hover:bg-gray-50 transition-colors line-form">
                                    {{ form.id }}
                                    <td class="p-4">
                                        {{ form.item }}
                                        {% if form.item.errors %}
                                        <div class="text-red-500 text-xs">{{ form.item.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-right">
                                        {{ form.quantity }}
                                        {% if form.quantity.errors %}
                                        <div class="text-red-500 text-xs">{{ form.quantity.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-right">
                                        {{ form.unit_price }}
                                        {% if form.unit_price.errors %}
                                        <div class="text-red-500 text-xs">{{ form.unit_price.errors.0 }}</div>
                                        {% endif %}
                                    </td>
                                    <td class="p-4 text-center">
                                        {{ form.DELETE }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </section>

            </div>

            <!-- 4. Action Bar (Bottom, Fixed) -->
            <footer
                class="h-16 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] shrink-0 flex items-center justify-between px-4 gap-4 z-20">
                <a href="{% url 'sales_order_list' %}"
                    class="flex-1 h-10 flex items-center justify-center gap-2 rounded-lg border border-gray-300 text-gray-700 font-bold active:bg-gray-100 hover:bg-gray-50 text-base no-underline">
                    Cancel
                </a>
                <button
                    class="flex-[2] h-12 bg-indigo-600 text-white rounded-lg font-bold shadow-lg shadow-indigo-200 active:bg-indigo-700 active:scale-95 transition-all text-lg flex items-center justify-center gap-2"
                    type="submit">
                    <span>ðŸ’¾</span> Save Order
                </button>
            </footer>
        </form>

    </main>

    <!-- Dependencies -->
    <script src="../js/mock_data.js"></script>
    <script src="../js/app.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Style the Django widgets to match Touch design
            const selects = document.querySelectorAll('select:not(#id_status)'); // Exclude status which is styled specifically
            selects.forEach(el => {
                el.classList.add('touch-input', 'w-full', 'border', 'border-gray-300', 'rounded', 'px-2', 'bg-white');
            });

            const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
            inputs.forEach(el => {
                if (!el.classList.contains('text-lg')) { // Don't style the top date input
                    el.classList.add('touch-input', 'w-full', 'border', 'border-gray-300', 'rounded', 'px-2');
                    if (el.type === 'number') el.classList.add('text-right', 'font-mono');
                }
            });
        });
    </script>

</body>

</html>